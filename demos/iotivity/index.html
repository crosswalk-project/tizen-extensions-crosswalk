<!DOCTYPE html>
<html>
<head>
<title>IOC Tizen Crosswalk Extension demo</title>
<link rel="stylesheet" type="text/css" href="style.css"/>
<meta name="viewport" content="width=device-width">
<style>
body {
  font-size: 2em;
}
</style>
</head>
<body>
<script>



var lightResource = null;
var device = new iotivity.OicDevice();

function startServer() {
  var deviceId = device.settings.info.uuid;
  var connMode = device.settings.connectionMode;
  // register all resources handled by this device
  device.server.registerResource({
    url: "/a/light",
    deviceId: deviceId,
    connectionMode: connMode,
    resourceTypes: [ "core.light", "core.brightlight" ],
    interfaces: [ "oic.if.baseline", "oic.if.ll"],
    discoverable: true,
    observable: true,
    properties: { power: "5", state: "true" }
  }).then(function(res) {
    console.log("Resource " + res.id + " has been created.");
    lightResource = res;
    device.server.onrequest = requestHandler;
    device.server.enablePresence();
  }, function(error) {
    console.log("Error creating resource " + res.url + " : " + error.message);
  });
};

function requestHandler(request) {
  console.log("requestHandler: type=" + request.type + " id=" + request.requestId);
  if (request.type == "update" && lightResource && request.target == lightResource.id) {
    var updates = [];
    for(var name in request.updatedPropertyNames) { // e.g. "color"
      if (request.properties[name] != lightResource.properties[name]) {
        lightResource.properties[name] = request.properties[name]; // save the change
        updates.push(name); // collect all the updates
      }
    }
    
    if (updates.length) {
      var error = 'Failed to handle update request'; // new Error("")
      request.sendError(error);
      //request.sendResponse(); // sends back OK
      
    }
    else {
      var error = 'Failed to handle update request'; // new Error("")
      request.sendError(error);
    }
  }

  if (request.type == "retrieve" && lightResource && request.target == lightResource.id) {
     request.sendResponse(); // sends back OK
  }

  if (request.type == "observe" && lightResource && request.target == lightResource.id) {
     request.sendResponse(); // sends back OK

     device.server.notify(lightResource.id, "update", updates); // tell observers
  }


  // handle the other types of requests as well...
};

// e.g. to handle the case when remote resources can influence the states of local resources
// for instance look for the state changes on dimming of the remote red light,
// update dimming the local blue light, then request dimming the remote light
function startClient() {

  // discover resources
  device.client.findResources({ 
     resourceType: "core.light"
   }).then(function(list) {      
        for(var i = 0; i < list.length; i++) {
          res = list[i];
          if(res.url == "/a/light") {
            device.client.startObserving(res.id)
              .then(function(red) {
                console.log("Observing " + res.url);
                red.properties.dimmer = 0.5;
                device.client.updateResource(red)
                  .then(function() { 
                     console.log("Changed red light dimmer");
                  },function() { 
                     console.log("Error changing red light"); 
                  });        
                }, function(error) { 
                  console.log("Cannot observe " + res.url); 
            });
          } // if
        }
      }, function(e) {
       console.log("Error finding resources: " + e.message);
    });
};

function testOicServerClient(){
 
  // implementation will try to get default configuration from the HW/platform
  // but if we cannot get it, could do a hard-coded configuration (not recommended)
  if (device.settings.info.uuid) { // configuration is valid
    //startServer();
    startClient();
  }
}



testOicServerClient();



</script>
</body>
</html>

